<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>DualPay - Изчисляване на ресто</title>

<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Шрифтове -->
<link href="https://fonts.googleapis.com/css2?family=Comfortaa&family=Montserrat&display=swap" rel="stylesheet" />

<style>
  body {
    font-family: 'Montserrat', sans-serif;
    background: #EDE7F6;
    margin: 0; padding: 0;
    overflow-x: hidden;
    -webkit-tap-highlight-color: transparent;
  }
  h1 {
    font-family: 'Comfortaa', cursive;
  }

  #app {
    max-width: 400px;
    margin: 2rem auto;
    padding: 1.5rem 1.5rem 2rem 1.5rem;
    background: rgba(255 255 255 / 0.65);
    border-radius: 1rem;
    backdrop-filter: blur(14px);
    box-shadow: 0 12px 25px rgb(0 0 0 / 0.15);
    position: relative;
    z-index: 10;
  }

  /* Фон с по-големи клетки и разстояние */
  #background {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
    z-index: 0;
    display: grid;
    grid-template-columns: repeat(auto-fill, 80px);
    grid-auto-rows: 80px;
    justify-content: center;
    opacity: 0.05;
  }
  .bg-symbol {
    font-family: 'Comfortaa', cursive;
    font-size: 40px;
    color: #006994;
    display: flex;
    justify-content: center;
    align-items: center;
    user-select: none;
    animation: floatAnim 8s ease-in-out infinite;
    transform-origin: center;
  }
  .bg-symbol:nth-child(odd) {
    animation-delay: 0s;
  }
  .bg-symbol:nth-child(even) {
    animation-delay: 4s;
  }

  @keyframes floatAnim {
    0%, 100% {
      transform: translate(0,0) rotate(0deg) scale(1);
    }
    50% {
      transform: translate(5px, 5px) rotate(7deg) scale(1.1);
    }
  }

  #logo {
    font-family: 'Comfortaa', cursive;
    background-color: #006994;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 1rem;
    font-size: 1.8rem;
    user-select: none;
    display: inline-block;
  }

  .accent {
    color: #006994;
  }
  button {
    background-color: #006994;
  }
  button:hover {
    background-color: #004e6a;
  }

  input, select {
    font-family: 'Montserrat', sans-serif;
    font-size: 1rem;
  }

  #sum-input {
    background-color: #D0E8FF;
  }

  .error {
    border: 2px solid #dc2626;
  }

  #change-output {
    transition: opacity 0.5s ease;
    opacity: 0;
  }
  #change-output.visible {
    opacity: 1;
  }

  .segmented-control {
    display: flex;
    border: 2px solid #006994;
    border-radius: 1rem;
    overflow: hidden;
    width: fit-content;
    user-select: none;
  }
  .segmented-control input[type="radio"] {
    display: none;
  }
  .segmented-control label {
    padding: 0.5rem 1.5rem;
    cursor: pointer;
    background-color: white;
    color: #006994;
    font-family: 'Comfortaa', cursive;
    transition: background-color 0.3s, color 0.3s;
  }
  .segmented-control input[type="radio"]:checked + label {
    background-color: #006994;
    color: white;
  }
</style>
</head>
<body>

<div id="background"></div>

<div id="app" role="main" aria-label="Приложение за изчисляване на ресто">

  <header class="mb-6 text-center">
    <div id="logo" aria-label="Лого DualPay">€ ⇄ лв</div>
    <h1 class="text-3xl mt-4 accent">DualPay - Изчисляване на ресто</h1>
  </header>

  <form id="calc-form" class="space-y-5" novalidate>

    <div>
      <label for="sum" class="block mb-1 font-semibold accent">Сума за плащане</label>
      <div class="flex gap-2">
        <input type="number" step="0.01" min="0" id="sum" name="sum" placeholder="0.00"
          class="rounded-md px-3 py-2 w-full" style="background-color:#D0E8FF;" required aria-required="true" />
        <select id="sum-currency" name="sum-currency" aria-label="Валута за сума" class="rounded-md px-3 py-2 accent">
          <option value="BGN">лв</option>
          <option value="EUR">€</option>
        </select>
      </div>
    </div>

    <div>
      <label for="paid-bgn" class="block mb-1 font-semibold accent">Платено в лв</label>
      <input type="number" step="0.01" min="0" id="paid-bgn" name="paid-bgn" placeholder="0.00" class="rounded-md px-3 py-2 w-full" />
    </div>

    <div>
      <label for="paid-eur" class="block mb-1 font-semibold accent">Платено в €</label>
      <input type="number" step="0.01" min="0" id="paid-eur" name="paid-eur" placeholder="0.00" class="rounded-md px-3 py-2 w-full" />
    </div>

    <fieldset class="mb-4">
      <legend class="font-semibold accent mb-2">Валута за показване на ресто</legend>
      <div class="segmented-control" role="radiogroup" aria-label="Избор на валута за ресто">
        <input type="radio" id="change-bgn" name="change-currency" value="BGN" checked />
        <label for="change-bgn">лв</label>
        <input type="radio" id="change-eur" name="change-currency" value="EUR" />
        <label for="change-eur">€</label>
      </div>
    </fieldset>

    <div id="error-msg" class="text-red-600 font-semibold mb-3 hidden" role="alert" aria-live="assertive">
      Недостатъчна платена сума!
    </div>

    <div id="change-output" aria-live="polite" aria-atomic="true">
      <p class="font-semibold accent text-xl">Ресто: <span id="change-value">-</span></p>
      <p class="text-sm text-gray-600" id="change-secondary"></p>
    </div>

  </form>

  <footer class="mt-8 text-center text-gray-600 text-sm select-none">
    Курс: 1 EUR = 1.95583 BGN<br />
    © Никола ШакеВ
  </footer>

</div>

<script>
  const RATE = 1.95583;

  const backgroundEl = document.getElementById('background');
  function createBackgroundGrid() {
    const cellSize = 80;
    const cols = Math.floor(window.innerWidth / cellSize) + 2;
    const rows = Math.floor(window.innerHeight / cellSize) + 2;
    backgroundEl.style.gridTemplateColumns = `repeat(${cols}, ${cellSize}px)`;
    backgroundEl.style.gridAutoRows = `${cellSize}px`;
    backgroundEl.innerHTML = '';
    let toggle = true;
    for(let i = 0; i < cols * rows; i++) {
      const span = document.createElement('span');
      span.className = 'bg-symbol';
      span.textContent = toggle ? '€' : 'лв';
      toggle = !toggle;
      if (i % cols === cols - 1) toggle = !toggle;
      backgroundEl.appendChild(span);
    }
  }
  createBackgroundGrid();
  window.addEventListener('resize', createBackgroundGrid);

  function createIcon() {
    const canvas = document.createElement('canvas');
    canvas.width = 128; canvas.height = 128;
    const ctx = canvas.getContext('2d');

    ctx.fillStyle = '#006994';
    ctx.roundRect = function(x,y,w,h,r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r);
      ctx.lineTo(x + w, y + h - r);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      ctx.lineTo(x + r, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
      ctx.fill();
    }
    ctx.roundRect(0, 0, 128, 128, 24);

    ctx.fillStyle = 'white';
    ctx.font = 'bold 60px Comfortaa, cursive';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('€ ⇄ лв', 64, 64);

    return canvas.toDataURL();
  }

  const iconURL = createIcon();
  function setFavicon(href) {
    ['icon', 'apple-touch-icon'].forEach(rel => {
      let link = document.querySelector(`link[rel="${rel}"]`);
      if (!link) {
        link = document.createElement('link');
        link.rel = rel;
        document.head.appendChild(link);
      }
      link.href = href;
    });
  }
  setFavicon(iconURL);

  const sumInput = document.getElementById('sum');
  const sumCurrency = document.getElementById('sum-currency');
  const paidBGN = document.getElementById('paid-bgn');
  const paidEUR = document.getElementById('paid-eur');
  const errorMsg = document.getElementById('error-msg');
  const changeOutput = document.getElementById('change-output');
  const changeValue = document.getElementById('change-value');
  const changeSecondary = document.getElementById('change-secondary');
  const changeCurrencyRadios = document.querySelectorAll('input[name="change-currency"]');

  function calcChange() {
    const sum = parseFloat(sumInput.value) || 0;
    const sumCur = sumCurrency.value;
    const paidB = parseFloat(paidBGN.value) || 0;
    const paidE = parseFloat(paidEUR.value) || 0;
    const changeCur = [...changeCurrencyRadios].find(r => r.checked).value;

    const sumBGN = sumCur === 'BGN' ? sum : sum * RATE;
    const paidBGNtotal = paidB + paidE * RATE;

    if (paidBGNtotal < sumBGN) {
      errorMsg.classList.remove('hidden');
      changeOutput.classList.remove('visible');
      sumInput.classList.add('error');
      paidBGN.classList.add('error');
      paidEUR.classList.add('error');
      return;
    }
    errorMsg.classList.add('hidden');
    sumInput.classList.remove('error');
    paidBGN.classList.remove('error');
    paidEUR.classList.remove('error');

    const changeBGN = paidBGNtotal - sumBGN;

    let mainChange, secondaryChange, mainSymbol, secondarySymbol;
    if (changeCur === 'BGN') {
      mainChange = changeBGN;
      secondaryChange = mainChange / RATE;
      mainSymbol = 'лв';
      secondarySymbol = '€';
    } else {
      mainChange = changeBGN / RATE;
      secondaryChange = changeBGN;
      mainSymbol = '€';
      secondarySymbol = 'лв';
    }
    changeValue.textContent = mainChange.toFixed(2) + ' ' + mainSymbol;
    changeSecondary.textContent = `≈ ${secondaryChange.toFixed(2)} ${secondarySymbol}`;

    changeOutput.classList.add('visible');
  }

  [sumInput, sumCurrency, paidBGN, paidEUR].forEach(el =>
    el.addEventListener('input', calcChange));
  changeCurrencyRadios.forEach(r => r.addEventListener('change', calcChange));

  calcChange();

  const manifest = {
    name: 'DualPay',
    short_name: 'DualPay',
    start_url: '.',
    display: 'standalone',
    background_color: '#EDE7F6',
    theme_color: '#006994',
    description: 'PWA за изчисляване на ресто в BGN и EUR',
    icons: [
      {
        src: iconURL,
        sizes: "128x128",
        type: "image/png"
      }
    ]
  };
  const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
  const manifestURL = URL.createObjectURL(manifestBlob);

  const linkManifest = document.createElement('link');
  linkManifest.rel = 'manifest';
  linkManifest.href = manifestURL;
  document.head.appendChild(linkManifest);

  const swCode = `
    const CACHE_NAME = 'dualpay-cache-v1';
    const urlsToCache = ['.'];

    self.addEventListener('install', event => {
      event.waitUntil(
        caches.open(CACHE_NAME)
          .then(cache => cache.addAll(urlsToCache))
          .then(() => self.skipWaiting())
      );
    });

    self.addEventListener('activate', event => {
      event.waitUntil(
        caches.keys().then(keys =>
          Promise.all(
            keys.filter(key => key !== CACHE_NAME).map(key => caches.delete(key))
          )
        ).then(() => self.clients.claim())
      );
    });

    self.addEventListener('fetch', event => {
      event.respondWith(
        caches.match(event.request)
          .then(response => response || fetch(event.request))
      );
    });
  `;
  const swBlob = new Blob([swCode], {type: 'application/javascript'});
  const swURL = URL.createObjectURL(swBlob);

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register(swURL)
      .then(() => console.log('Service Worker регистриран успешно'))
      .catch(err => console.error('Грешка при регистрация на SW:', err));
  }
</script>

</body>
</html>

